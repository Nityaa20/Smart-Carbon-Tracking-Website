<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Carbon Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --primary-color: #4CAF50; --secondary-color: #f4f6f8; --text-color: #333;
            --background-color: #fff; --card-background: #fff; --border-color: #e0e0e0;
            --sidebar-width: 250px; --danger-color: #f44336;
        }
        body.dark-mode {
            --secondary-color: #121212; --text-color: #e0e0e0; --background-color: #1e1e1e;
            --card-background: #2a2a2a; --border-color: #444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--secondary-color); color: var(--text-color); display: flex; transition: background-color 0.3s, color 0.3s; }
        
        /* --- Authentication Styles --- */
        #auth-view {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .auth-container {
            background-color: var(--background-color);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-container .logo { justify-content: center; margin-bottom: 30px; }
        .auth-container h3 { margin-bottom: 25px; font-weight: 500; }
        .auth-container .form-group { margin-bottom: 20px; text-align: left; }
        .auth-container .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .auth-container .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--secondary-color); color: var(--text-color); font-size: 16px; }
        .auth-container .btn { width: 100%; font-size: 16px; }
        .switch-auth { margin-top: 20px; }
        .switch-auth a { color: var(--primary-color); text-decoration: none; font-weight: 500; cursor: pointer; }
        #signup-form { display: none; }

        /* --- Dashboard Styles --- */
        #dashboard-view { display: none; width: 100%; }
        .container { display: flex; width: 100%; }
        .sidebar { width: var(--sidebar-width); background-color: var(--background-color); padding: 20px; height: 100vh; position: fixed; border-right: 1px solid var(--border-color); transition: all 0.3s ease; z-index: 100; }
        body.sidebar-collapsed .sidebar { transform: translateX(-100%); }
        .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 40px; color: var(--primary-color); }
        .logo .fa-leaf { font-size: 28px; } .logo h2 { font-weight: 700; }
        .nav ul { list-style: none; } .nav ul li { margin-bottom: 15px; }
        .nav ul li a { text-decoration: none; color: var(--text-color); display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 8px; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .nav ul li.active a, .nav ul li a:hover { background-color: var(--primary-color); color: #fff; }
        .main-content { margin-left: var(--sidebar-width); padding: 20px; width: calc(100% - var(--sidebar-width)); transition: all 0.3s ease; }
        body.sidebar-collapsed .main-content { margin-left: 0; width: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background-color: var(--background-color); padding: 15px 20px; border-radius: 10px; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-left i { font-size: 20px; cursor: pointer; } .header-left h2 { font-weight: 700; color: var(--primary-color); }
        .header-right { display: flex; align-items: center; gap: 25px; }
        .user-info a { text-decoration: none; color: var(--text-color); display: flex; align-items: center; gap: 8px; cursor: pointer;}
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background-color: #45a049; }
        .dashboard-cards, .analytics-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background-color: var(--card-background); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card h3 { margin-bottom: 15px; } .card h4 { color: #666; margin-bottom: 10px; } .card .value { font-size: 2.2em; font-weight: 700; }
        .charts { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { background-color: var(--card-background); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 350px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .recent-emissions table { width: 100%; border-collapse: collapse; } .recent-emissions th, .recent-emissions td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .content-section { display: none; } .content-section.active { display: block; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .setting-card { background-color: var(--card-background); padding: 25px; border-radius: 10px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--secondary-color); color: var(--text-color); }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border-radius: 50%; border: none; font-size: 24px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1001; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1002; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: var(--background-color); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; } .close-modal { cursor: pointer; font-size: 24px; }
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-tab { padding: 10px 15px; cursor: pointer; border-radius: 8px 8px 0 0; }
        .modal-tab.active { background-color: var(--primary-color); color: white; }
        .modal-tab-content { display: none; } .modal-tab-content.active { display: block; }
        .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 15px; width: 0%; background-color: var(--primary-color); border-radius: 10px; transition: width 0.5s ease; }
        .progress-bar.exceeded { background-color: var(--danger-color); }
        .leaderboard { width: 100%; border-collapse: collapse; } .leaderboard th, .leaderboard td { padding: 15px; text-align: left; } .leaderboard tr:nth-child(even) { background-color: var(--secondary-color); } .leaderboard .user-row { font-weight: bold; color: var(--primary-color); }
        .equivalency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; text-align: center; }
        .equivalency-item { background: var(--secondary-color); padding: 15px; border-radius: 8px;}
        .equivalency-item .fas { font-size: 2em; color: var(--primary-color); margin-bottom: 10px; }
        .equivalency-item p { font-size: 1.1em; font-weight: 500; }
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .eco-tip-card { background-color: #e8f5e9; border-left: 5px solid var(--primary-color); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .eco-tip-card h4 { color: var(--primary-color); font-weight: 700; margin-bottom: 5px; font-size: 0.9em; }
        .eco-tip-card h3 { color: var(--text-color); font-weight: 700; margin-bottom: 10px; }
        .eco-tip-card p { margin-bottom: 15px; }
        .tags-container { display: flex; gap: 10px; }
        .tag { padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 500; }
        .tag-medium { background-color: #fffde7; color: #f57f17; }
        .tag-lifestyle { background-color: #e1f5fe; color: #0277bd; }
        body.dark-mode .eco-tip-card { background-color: #2c3b2d; }
        body.dark-mode .eco-tip-card h3, body.dark-mode .eco-tip-card p { color: var(--text-color); }
        body.dark-mode .tag-medium { background-color: #4a401f; color: #ffd54f; }
        body.dark-mode .tag-lifestyle { background-color: #1c3d4f; color: #4fc3f7; }
    </style>
</head>
<body>
    <!-- Authentication View -->
    <div id="auth-view">
        <div class="auth-container">
            <div class="logo"><i class="fas fa-leaf"></i><h2>Smart Carbon Tracker</h2></div>
            <form id="signin-form">
                <h3>Welcome Back!</h3>
                <div class="form-group"><label for="email">Email</label><input type="email" placeholder="you@example.com" required></div>
                <div class="form-group"><label for="password">Password</label><input type="password" placeholder="••••••••" required></div>
                <button type="submit" class="btn btn-primary">Sign In</button>
                <div class="switch-auth"><p>Don't have an account? <a id="show-signup">Sign Up</a></p></div>
            </form>
            <form id="signup-form">
                <h3>Create Your Account</h3>
                <div class="form-group"><label>Name</label><input type="text" placeholder="Jane Doe" required></div>
                <div class="form-group"><label>Email</label><input type="email" placeholder="you@example.com" required></div>
                <div class="form-group"><label>Password</label><input type="password" placeholder="••••••••" required></div>
                <button type="submit" class="btn btn-primary">Create Account</button>
                <div class="switch-auth"><p>Already have an account? <a id="show-signin">Sign In</a></p></div>
            </form>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view">
        <div class="container">
            <aside class="sidebar">
                <div class="logo"><i class="fas fa-leaf"></i><h2>Menu</h2></div>
                <nav class="nav">
                    <ul>
                        <li class="active"><a href="#" data-target="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" data-target="analytics"><i class="fas fa-chart-line"></i> Analytics</a></li>
                        <li><a href="#" data-target="impact"><i class="fas fa-leaf"></i> My Impact</a></li>
                        <li><a href="#" data-target="community"><i class="fas fa-users"></i> Community</a></li>
                        <li><a href="#" data-target="settings"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </nav>
            </aside>
            <main class="main-content">
                <header class="header">
                    <div class="header-left"><i class="fas fa-bars" id="toggle-sidebar"></i><h2>Smart Carbon Tracker</h2></div>
                    <div class="header-right"><div class="user-info"><a id="sign-out-btn"><span>Sign Out</span><i class="fas fa-sign-out-alt"></i></a></div></div>
                </header>
                <div id="dashboard" class="content-section active">
                    <section class="eco-tip-card">
                        <h4>Eco Tip of the Day</h4><h3>Reduce, Reuse, Recycle</h3><p>A new tip every day to help you reduce your carbon footprint.</p>
                        <div class="tags-container"><span class="tag tag-medium">MEDIUM</span><span class="tag tag-lifestyle">lifestyle</span></div>
                    </section>
                    <section class="dashboard-cards">
                        <div class="card"><h4>Today's Emissions</h4><p class="value" id="today-emissions">0.0</p><p class="unit">kg CO₂</p></div>
                        <div class="card"><h4>Weekly Average</h4><p class="value" id="weekly-average">0.0</p><p class="unit">kg CO₂/day</p></div>
                        <div class="card">
                            <h4>Weekly Goal Progress</h4><p id="goal-text">No goal set</p>
                            <div class="progress-bar-container"><div id="goal-progress-bar" class="progress-bar"></div></div>
                        </div>
                    </section>
                    <section class="charts">
                        <div class="chart-container"><canvas id="daily-emissions-chart"></canvas></div>
                        <div class="chart-container"><canvas id="emissions-by-source-chart"></canvas></div>
                    </section>
                    <section class="recent-emissions card">
                        <div class="section-header"><h3>Recent Emissions</h3><button id="export-csv" class="btn btn-secondary"><i class="fas fa-download"></i> Export CSV</button></div>
                        <table><thead><tr><th>Time</th><th>Source</th><th>Details</th><th>Emissions (kg CO₂)</th></tr></thead><tbody id="recent-emissions-table"></tbody></table>
                    </section>
                </div>
                <div id="analytics" class="content-section">
                    <h2>Advanced Analytics</h2>
                    <section class="charts" style="grid-template-columns: 1fr 1fr;">
                        <div class="chart-container"><h3>Weekly Breakdown</h3><canvas id="weekly-comparison-chart"></canvas></div>
                        <div class="chart-container"><h3>Transport Detail</h3><canvas id="transport-breakdown-chart"></canvas></div>
                    </section>
                    <section class="card">
                        <h3>Historical Trends</h3><p>Analyze your emissions over longer periods to identify patterns and track your progress effectively.</p>
                        <div class="form-group" style="max-width: 400px; margin-top: 15px;"><label for="time-range">Select Time Range</label><select id="time-range"><option value="7">Last 7 Days</option><option value="30">Last 30 Days</option><option value="all">All Time</option></select></div>
                    </section>
                </div>
                <div id="impact" class="content-section">
                    <h2>My Impact</h2>
                    <div class="card" style="margin-bottom: 20px;">
                        <h4>Monthly Carbon Debt</h4><p>Your emissions this month have created a carbon debt of <strong id="carbon-debt">0.0 kg CO₂</strong>. This is equivalent to:</p>
                        <div class="equivalency-grid">
                            <div class="equivalency-item"><i class="fas fa-car"></i><p><span id="equiv-car">0</span> km driven</p></div>
                            <div class="equivalency-item"><i class="fas fa-charging-station"></i><p><span id="equiv-phone">0</span> smartphones charged</p></div>
                            <div class="equivalency-item"><i class="fas fa-tree"></i><p><span id="equiv-tree">0</span> tree seedlings grown for 10 years</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Offset Your Footprint</h3><p>You can balance your carbon debt by supporting certified climate projects. Common types of carbon offset projects include reforestation, renewable energy, and methane capture. By investing in these, you help reduce global greenhouse gas emissions.</p>
                        <button id="offset-btn" class="btn btn-primary" style="margin-top: 15px;">Explore Offset Projects</button>
                    </div>
                </div>
                <div id="community" class="content-section">
                    <h2>Community</h2>
                    <div class="card" style="margin-bottom: 20px;"><h4>This Week's Challenge</h4><p>The Green Commute Challenge! Log the most km by bike or walking to win.</p></div>
                    <div class="card">
                        <h3>Weekly Leaderboard</h3>
                        <table class="leaderboard"><thead><tr><th>Rank</th><th>User</th><th>CO₂ Saved (kg)</th></tr></thead>
                            <tbody>
                                <tr><td>1</td><td>User #4815</td><td>55.2</td></tr><tr><td>2</td><td>User #1623</td><td>51.8</td></tr>
                                <tr class="user-row"><td>3</td><td>You</td><td id="user-saved-leaderboard">45.1</td></tr>
                                <tr><td>4</td><td>User #4289</td><td>42.5</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="settings" class="content-section">
                    <h2>Settings</h2>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>General</h3>
                            <div class="form-group toggle-switch"><label for="dark-mode-toggle">Dark Mode</label><label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label></div>
                            <!-- NEW NOTIFICATION TOGGLE -->
                            <div class="form-group toggle-switch"><label for="notifications-toggle">Push Notifications</label><label class="switch"><input type="checkbox" id="notifications-toggle" checked><span class="slider"></span></label></div>
                            <div class="form-group"><label for="weekly-goal">Set Weekly CO₂ Target (kg)</label><input type="number" id="weekly-goal" placeholder="e.g., 40"></div>
                            <button id="save-goal-btn" class="btn btn-primary">Save Goal</button>
                        </div>
                        <div class="setting-card">
                            <h3>Account</h3>
                            <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" value="you@example.com" disabled></div>
                             <button class="btn">Change Password</button>
                        </div>
                         <div class="setting-card">
                            <h3>Data Management</h3><p>Export your data or reset your account. <strong>Warning:</strong> Resetting is permanent.</p>
                            <button id="reset-data-btn" class="btn" style="background-color: var(--danger-color); color: white; margin-top: 15px;">Reset All Data</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div class="modal-overlay" id="add-entry-modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Log New Entry</h3><span class="close-modal" id="close-modal">&times;</span></div>
            <div class="modal-tabs"><div class="modal-tab active" data-tab="travel">Travel</div><div class="modal-tab" data-tab="energy">Energy</div><div class="modal-tab" data-tab="food">Food</div></div>
            <form id="log-entry-form">
                <div class="modal-tab-content active" id="travel-tab">
                    <div class="form-group"><label>Mode</label><select id="travel-mode"><option value="car">Car</option><option value="bus">Bus</option><option value="bike">Bike</option><option value="walk">Walk</option></select></div>
                    <div class="form-group"><label>Distance (km)</label><input type="number" id="travel-distance" required></div>
                </div>
                <div class="modal-tab-content" id="energy-tab"><div class="form-group"><label>Electricity Usage (kWh)</label><input type="number" id="energy-kwh" required></div></div>
                <div class="modal-tab-content" id="food-tab"><div class="form-group"><label>Meal Type</label><select id="food-type"><option value="meat">Meat-based</option><option value="vegetarian">Vegetarian</option><option value="vegan">Vegan</option></select></div></div>
                <button type="submit" class="btn btn-primary">Log Emission</button>
            </form>
        </div>
    </div>
    <button class="fab" id="fab-add-entry"><i class="fas fa-plus"></i></button>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showSigninBtn = document.getElementById('show-signin');
        const signOutBtn = document.getElementById('sign-out-btn');
        const fab = document.getElementById('fab-add-entry');
        const modal = document.getElementById('add-entry-modal');

        function showDashboard() {
            authView.style.display = 'none';
            dashboardView.style.display = 'block';
            fab.style.display = 'flex'; // Show FAB on dashboard
            // Request notification permission when user logs in
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        function showAuth() {
            dashboardView.style.display = 'none';
            authView.style.display = 'flex';
            fab.style.display = 'none'; // Hide FAB on auth screen
            modal.classList.remove('show'); // Ensure modal is closed
        }

        signinForm.addEventListener('submit', (e) => { e.preventDefault(); showDashboard(); });
        signupForm.addEventListener('submit', (e) => { e.preventDefault(); showDashboard(); });
        signOutBtn.addEventListener('click', showAuth);
        showSignupBtn.addEventListener('click', () => { signinForm.style.display = 'none'; signupForm.style.display = 'block'; });
        showSigninBtn.addEventListener('click', () => { signupForm.style.display = 'none'; signinForm.style.display = 'block'; });

        let appState = { emissions: [], weeklyGoal: null, notificationsEnabled: true, goalExceededNotified: false };
        const EMISSION_FACTORS = { car: 0.2, bus: 0.1, bike: 0, walk: 0, energy: 0.5, meat: 5, vegetarian: 2.5, vegan: 1 };
        const EQUIVALENCY_FACTORS = { car: 5, phone: 121, tree: 0.06 };

        const closeModalBtn = document.getElementById('close-modal');
        const logEntryForm = document.getElementById('log-entry-form');
        const modalTabs = document.querySelectorAll('.modal-tab');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const navLinks = document.querySelectorAll('.nav a');
        const contentSections = document.querySelectorAll('.content-section');
        const saveGoalBtn = document.getElementById('save-goal-btn');
        const offsetBtn = document.getElementById('offset-btn');
        const exportCsvBtn = document.getElementById('export-csv');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const notificationsToggle = document.getElementById('notifications-toggle');
        const resetDataBtn = document.getElementById('reset-data-btn');

        let dailyEmissionsChart, emissionsBySourceChart, weeklyComparisonChart, transportBreakdownChart;
        initializeCharts();
        updateDashboard();

        toggleSidebarBtn.addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));
        fab.addEventListener('click', () => modal.classList.add('show'));
        closeModalBtn.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                contentSections.forEach(s => s.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                navLinks.forEach(n => n.parentElement.classList.remove('active'));
                link.parentElement.classList.add('active');
            });
        });

        modalTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.getAttribute('data-tab');
                modalTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${target}-tab`).classList.add('active');
            });
        });

        logEntryForm.addEventListener('submit', (e) => { e.preventDefault(); logNewEmission(); modal.classList.remove('show'); });
        
        saveGoalBtn.addEventListener('click', () => {
            const goalValue = document.getElementById('weekly-goal').value;
            appState.weeklyGoal = parseFloat(goalValue) || null;
            appState.goalExceededNotified = false; // Reset notification status for new goal
            updateDashboard();
            alert('Goal saved!');
        });
        
        offsetBtn.addEventListener('click', () => {
            const debt = calculateCarbonDebt().toFixed(1);
            alert(`Thank you for your interest in offsetting ${debt} kg of CO₂! This would link to a real offset service.`);
        });
        
        exportCsvBtn.addEventListener('click', exportToCSV);
        darkModeToggle.addEventListener('change', () => { document.body.classList.toggle('dark-mode'); });
        
        notificationsToggle.addEventListener('change', (e) => {
            appState.notificationsEnabled = e.target.checked;
        });

        resetDataBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all your data? This action cannot be undone.')) {
                appState.emissions = [];
                appState.weeklyGoal = null;
                appState.goalExceededNotified = false;
                updateDashboard();
                alert('All data has been reset.');
            }
        });
        
        function showGoalExceededNotification() {
            if ('Notification' in window && Notification.permission === 'granted' && appState.notificationsEnabled) {
                const notification = new Notification('Weekly Goal Exceeded', {
                    body: `You've surpassed your weekly carbon limit of ${appState.weeklyGoal} kg CO₂.`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2942/2942119.png' // A generic leaf icon
                });
            }
        }

        function logNewEmission() {
            const activeTab = document.querySelector('.modal-tab.active').getAttribute('data-tab');
            let emission = { timestamp: new Date(), source: '', details: '', value: 0 };
            if (activeTab === 'travel') {
                const mode = document.getElementById('travel-mode').value;
                const distance = parseFloat(document.getElementById('travel-distance').value);
                emission.source = 'Transportation';
                emission.details = `${mode.charAt(0).toUpperCase() + mode.slice(1)} (${distance} km)`;
                emission.value = EMISSION_FACTORS[mode] * distance;
                emission.subSource = mode;
            } else if (activeTab === 'energy') {
                const kwh = parseFloat(document.getElementById('energy-kwh').value);
                emission.source = 'Energy'; emission.details = `${kwh} kWh used`;
                emission.value = EMISSION_FACTORS.energy * kwh;
            } else if (activeTab === 'food') {
                const type = document.getElementById('food-type').value;
                emission.source = 'Food'; emission.details = `${type.charAt(0).toUpperCase() + type.slice(1)} meal`;
                emission.value = EMISSION_FACTORS[type];
            }
            appState.emissions.push(emission);
            updateDashboard();
        }

        function updateDashboard() {
            const todayEmissions = calculateTodaysEmissions();
            const weeklyTotal = calculateWeeklyTotal();
            document.getElementById('today-emissions').textContent = todayEmissions.toFixed(1);
            document.getElementById('weekly-average').textContent = (appState.emissions.length > 0 ? weeklyTotal / 7 : 0).toFixed(1);
            const goalText = document.getElementById('goal-text');
            const progressBar = document.getElementById('goal-progress-bar');
            if (appState.weeklyGoal) {
                const progressPercent = Math.min((weeklyTotal / appState.weeklyGoal) * 100, 100);
                goalText.textContent = `${weeklyTotal.toFixed(1)} / ${appState.weeklyGoal} kg used`;
                progressBar.style.width = `${progressPercent}%`;
                progressBar.classList.toggle('exceeded', weeklyTotal > appState.weeklyGoal);

                if (weeklyTotal > appState.weeklyGoal && !appState.goalExceededNotified) {
                    showGoalExceededNotification();
                    appState.goalExceededNotified = true; // Set flag to prevent spamming
                }
            } else {
                goalText.textContent = 'No goal set'; progressBar.style.width = '0%';
            }
            const tableBody = document.getElementById('recent-emissions-table');
            tableBody.innerHTML = '';
            appState.emissions.slice().reverse().slice(0, 5).forEach(e => {
                tableBody.innerHTML += `<tr><td>${new Date(e.timestamp).toLocaleTimeString()}</td><td>${e.source}</td><td>${e.details}</td><td>${e.value.toFixed(1)}</td></tr>`;
            });
            updateImpactPage();
            updateCharts();
        }
        
        function updateImpactPage() {
            const debt = calculateCarbonDebt();
            document.getElementById('carbon-debt').textContent = debt.toFixed(1);
            document.getElementById('equiv-car').textContent = (debt * EQUIVALENCY_FACTORS.car).toFixed(1);
            document.getElementById('equiv-phone').textContent = Math.round(debt * EQUIVALENCY_FACTORS.phone);
            document.getElementById('equiv-tree').textContent = (debt * EQUIVALENCY_FACTORS.tree).toFixed(2);
        }

        function calculateTodaysEmissions() {
            const today = new Date().setHours(0, 0, 0, 0);
            return appState.emissions.filter(e => new Date(e.timestamp).setHours(0, 0, 0, 0) === today).reduce((sum, e) => sum + e.value, 0);
        }
        function calculateWeeklyTotal() { return appState.emissions.reduce((sum, e) => sum + e.value, 0); }
        function calculateCarbonDebt() { return calculateWeeklyTotal(); }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Timestamp,Source,Details,Emissions (kg CO2)\n";
            appState.emissions.forEach(e => { csvContent += [new Date(e.timestamp).toLocaleString(), e.source, `"${e.details}"`, e.value.toFixed(2)].join(",") + "\n"; });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "carbon_tracker_export.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function initializeCharts() {
            dailyEmissionsChart = new Chart(document.getElementById('daily-emissions-chart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'kg CO₂', data: [], borderColor: '#4CAF50', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Recent Emission Entries' }}}});
            emissionsBySourceChart = new Chart(document.getElementById('emissions-by-source-chart').getContext('2d'), { type: 'doughnut', data: { labels: ['Transportation', 'Energy', 'Food'], datasets: [{ data: [], backgroundColor: ['#4CAF50', '#2196F3', '#FFC107'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Emissions by Source' }}}});
            weeklyComparisonChart = new Chart(document.getElementById('weekly-comparison-chart').getContext('2d'), { type: 'bar', data: { labels: ['Last Week', 'This Week'], datasets: [{ label: 'kg CO₂', data: [120, calculateWeeklyTotal()], backgroundColor: ['#FFC107', '#4CAF50'] }] }, options: { responsive: true, maintainAspectRatio: false }});
            transportBreakdownChart = new Chart(document.getElementById('transport-breakdown-chart').getContext('2d'), { type: 'pie', data: { labels: ['Car', 'Bus', 'Bike/Walk'], datasets: [{ data: [], backgroundColor: ['#f44336', '#FF9800', '#4CAF50'] }] }, options: { responsive: true, maintainAspectRatio: false }});
        }
        
        function updateCharts() {
            const sourceTotals = appState.emissions.reduce((acc, e) => { acc[e.source] = (acc[e.source] || 0) + e.value; return acc; }, {});
            emissionsBySourceChart.data.datasets[0].data = [sourceTotals['Transportation'] || 0, sourceTotals['Energy'] || 0, sourceTotals['Food'] || 0];
            emissionsBySourceChart.update();
            const last7Emissions = appState.emissions.slice(-7);
            dailyEmissionsChart.data.labels = last7Emissions.map(e => new Date(e.timestamp).toLocaleTimeString());
            dailyEmissionsChart.data.datasets[0].data = last7Emissions.map(e => e.value.toFixed(1));
            dailyEmissionsChart.update();
            weeklyComparisonChart.data.datasets[0].data[1] = calculateWeeklyTotal();
            weeklyComparisonChart.update();
            const transportTotals = appState.emissions.filter(e => e.source === 'Transportation').reduce((acc, e) => {
                const subSource = (e.subSource === 'bike' || e.subSource === 'walk') ? 'Bike/Walk' : e.subSource.charAt(0).toUpperCase() + e.subSource.slice(1);
                acc[subSource] = (acc[subSource] || 0) + e.value; return acc; }, {});
            transportBreakdownChart.data.datasets[0].data = [transportTotals['Car'] || 0, transportTotals['Bus'] || 0, transportTotals['Bike/Walk'] || 0];
            transportBreakdownChart.update();
        }
    });
    </script>
</body>
</html>